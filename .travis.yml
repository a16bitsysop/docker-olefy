import: a16bitsysop/travis-build-configs:docker-apt.yml

env:
  - IMAGE_NAME=a16bitsysop/olefy url=HeinleinSupport/olefy/master/olefy.py

before_script:
  - ALP=$(version.py -b)
  - VER="$(version.py -g $url)$ALP"
  - TAG="-t $IMAGE_NAME:$(date +%d%m%g)-alpine$ALP"
  - MY_ALP=$(docker container run --rm $IMAGE_NAME cat /etc/alpine-release)
  - MY_VER="$(version.py -f $IMAGE_NAME)$MY_ALP"
  - |
     echo "Checking if update needed..."
     echo "Git    version is $VER"
     echo "Docker version is $MY_VER"
     if [ -z $NOW ] && [ "$MY_VER" = "$VER" ]; then travis_terminate 0; fi

script:
  - if [ -z "$NOW" ] || [ "$NOW" = "later" ]; then for i in {1..15}; do sleep 1m; echo "waiting $i mins"; done; fi
  - docker buildx build --platform linux/amd64,linux/386,linux/ppc64le,linux/s390x,linux/arm64,linux/arm/v7 $TAG -t "$IMAGE_NAME" --push .
  - curl -X POST "https://hooks.microbadger.com/images/$IMAGE_NAME/$WEBHOOK"
